name: Sync R2 Data

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "data/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-24.04
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - name: Setup Bun
        uses: oven-sh/setup-bun@f4d14e03ff726c06358e5557344e1da148b56cf7 # v1.2.2
        with:
          bun-version: "1.1.14"
      - name: Install
        run: bun install --frozen-lockfile
      - name: Build data
        run: bun sites/pages/build.ts
      - name: Upload data to R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          set -euo pipefail
          BUCKET="idx-md"
          UPLOAD_CONCURRENCY="${UPLOAD_CONCURRENCY:-4}"
          UPLOAD_RETRIES="${UPLOAD_RETRIES:-5}"
          UPLOAD_SLEEP_BASE="${UPLOAD_SLEEP_BASE:-2}"
          if [ ! -d data ]; then
            echo "data/ missing"
            exit 1
          fi
          find data -type f -print0 | xargs -0 -n1 -P "$UPLOAD_CONCURRENCY" -I{} bash -c '
            file="$1"
            key="${file#./}"
            attempt=1
            while true; do
              if bunx wrangler r2 object put "$BUCKET/$key" --file "$file" --remote; then
                exit 0
              fi
              if [ "$attempt" -ge "$UPLOAD_RETRIES" ]; then
                echo "Upload failed after ${attempt} attempts: ${file}"
                exit 1
              fi
              sleep_for=$((UPLOAD_SLEEP_BASE * attempt))
              echo "Retry ${attempt}/${UPLOAD_RETRIES} for ${file} after ${sleep_for}s"
              sleep "$sleep_for"
              attempt=$((attempt + 1))
            done
          ' _ {}
      - name: Configure git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
      - name: Commit data
        run: |
          git add data
          if git diff --cached --quiet; then
            echo "No data changes to commit."
            exit 0
          fi
          git commit -m "data: refresh data"
          git push
