name: Sync R2 Data

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "data/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - name: Setup Bun
        uses: oven-sh/setup-bun@f4d14e03ff726c06358e5557344e1da148b56cf7 # v1.2.2
        with:
          bun-version: "1.1.14"
      - name: Install
        run: bun install --frozen-lockfile
      - name: Snapshot previous data
        run: |
          rm -rf data_prev
          if [ -d data ]; then
            cp -R data data_prev
          fi
      - name: Build data
        run: bun sites/pages/build.ts
      - name: Compare content hashes
        id: compare
        run: |
          if [ ! -d data_prev ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          output=$(bun sites/pages/compare-content-hash.ts data_prev data)
          echo "$output"
          changed=$(echo "$output" | grep -m1 '^changed=' | cut -d= -f2)
          if [ -z "$changed" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "changed=$changed" >> "$GITHUB_OUTPUT"
      - name: Upload data to R2
        if: ${{ steps.compare.outputs.changed == 'true' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          set -euo pipefail
          BUCKET="idx-md"
          UPLOAD_CONCURRENCY="${UPLOAD_CONCURRENCY:-8}"
          UPLOAD_RETRIES="${UPLOAD_RETRIES:-8}"
          UPLOAD_SLEEP_BASE="${UPLOAD_SLEEP_BASE:-3}"
          UPLOAD_FILE_TIMEOUT="${UPLOAD_FILE_TIMEOUT:-60}"
          export BUCKET
          export UPLOAD_CONCURRENCY
          export UPLOAD_RETRIES
          export UPLOAD_SLEEP_BASE
          export UPLOAD_FILE_TIMEOUT
          if [ ! -d data ]; then
            echo "data/ missing"
            exit 1
          fi
          upload_list="$(mktemp)"
          trap 'rm -f "$upload_list"' EXIT
          if [ ! -d data_prev ]; then
            find data -type f -print0 > "$upload_list"
          else
            while IFS= read -r -d '' file; do
              relative_path="${file#data/}"
              if [ ! -f "data_prev/$relative_path" ]; then
                printf '%s\0' "$file" >> "$upload_list"
              fi
            done < <(find data -type f -print0)
          fi
          total_files=$(awk 'BEGIN { RS = "\0" } END { print NR }' "$upload_list")
          if [ "$total_files" -eq 0 ]; then
            echo "No new files to upload."
            exit 0
          fi
          echo "Uploading ${total_files} new files with concurrency=${UPLOAD_CONCURRENCY} timeout=${UPLOAD_FILE_TIMEOUT}s"
          if ! xargs -0 -P "$UPLOAD_CONCURRENCY" -I{} bash -c '
            file="$1"
            key="${file#./}"
            attempt=1
            while true; do
              if timeout "$UPLOAD_FILE_TIMEOUT" bunx wrangler r2 object put "$BUCKET/$key" --file "$file" --remote; then
                exit 0
              fi
              if [ "$attempt" -ge "$UPLOAD_RETRIES" ]; then
                echo "Upload failed after ${attempt} attempts: ${file}"
                exit 1
              fi
              sleep_for=$((UPLOAD_SLEEP_BASE * attempt))
              echo "Retry ${attempt}/${UPLOAD_RETRIES} for ${file} after ${sleep_for}s"
              sleep "$sleep_for"
              attempt=$((attempt + 1))
            done
          ' _ {} < "$upload_list"; then
            echo "Upload failed. Tail of latest Wrangler log (if present):"
            latest_log=$(ls -t /home/runner/.config/.wrangler/logs/wrangler-*.log 2>/dev/null | head -n 1 || true)
            if [ -n "$latest_log" ] && [ -f "$latest_log" ]; then
              echo "==> ${latest_log}"
              tail -n 200 "$latest_log" || true
            else
              echo "No Wrangler logs found."
            fi
            exit 1
          fi
      - name: Configure git
        if: ${{ steps.compare.outputs.changed == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
      - name: Commit data
        if: ${{ steps.compare.outputs.changed == 'true' }}
        run: |
          git add data
          if git diff --cached --quiet; then
            echo "No data changes to commit."
            exit 0
          fi
          git commit -m "data: refresh data"
          git push
