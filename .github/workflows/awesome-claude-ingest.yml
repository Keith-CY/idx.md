name: Awesome Claude Ingest

on:
  schedule:
    - cron: "0 5 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  ingest:
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - name: Setup Bun
        uses: oven-sh/setup-bun@f4d14e03ff726c06358e5557344e1da148b56cf7 # v1.2.2
        with:
          bun-version: "1.1.14"
      - name: Install
        run: bun install --frozen-lockfile
      - name: Ingest awesome claude markdown
        run: bun sites/pages/ingest-awesome-claude.ts
      - name: Build data
        run: bun sites/pages/build.ts
      - name: Validate data
        run: bun run validate
      - name: Upload rejected report
        if: ${{ always() }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: awesome-claude-rejected-report
          path: data/reports/rejected.md
          if-no-files-found: ignore
      - name: Remove rejected report
        run: rm -f data/reports/rejected.md
      - name: Create pull request
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          commit-message: "sources: update awesome claude sources"
          title: "chore: update awesome claude sources"
          body: |
            Automated update of awesome-claude source registry.

            Generator:
            - Script: `sites/pages/ingest-awesome-claude.ts`
            - Repo SHA: `${{ github.sha }}`
            - Workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          branch: automation/awesome-claude-ingest
          delete-branch: true
          add-paths: |
            sources/general.yml
